#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>

#define BUFFER_SIZE 1024
char global_buffer[BUFFER_SIZE];

const char* skip_whitespace(const char* str) {
    while (isspace((unsigned char)*str)) {
        str++;
    }
    return str;
}

int is_matching_key(const char** p, const char* key) {
    const char* key_start = *p;
    int key_length = strlen(key);

    while (**p && **p != '\"' && (*p - key_start) < key_length) {
        if (*(*p)++ != key[(*p) - key_start - 1]) {
            return 0;  // Not the key we're looking for
        }
    }

    if ((*p - key_start) == key_length && **p == '\"') {
        (*p)++;  // Skip the closing quote
        return 1;  // Found the key
    }

    return 0;
}

void extract_value(const char** p) {
    *p = skip_whitespace(*p);  // Skip whitespace before the value

    if (**p == '\"') {
        (*p)++;  // Skip the opening quote of the value
        const char* value_start = *p;

        while (**p && **p != '\"') (*p)++;  // Find end of the value

        if (**p == '\"') {
            int len = *p - value_start;
            if (len >= BUFFER_SIZE) len = BUFFER_SIZE - 1;

            strncpy(global_buffer, value_start, len);
            global_buffer[len] = '\0';
        }
    }
}

void parse_json_and_find_key(const char* json) {
    const char* key_to_find = "liveoverflow";

    for (const char* p = json; *p; ++p) {
        p = skip_whitespace(p);

        if (*p == '\"') {
            p++;  // Skip the opening quote

            if (is_matching_key(&p, key_to_find)) {
                p = skip_whitespace(p);  // Skip whitespace after the key

                if (*p == ':') {
                    p++;  // Skip the colon
                    extract_value(&p);
                }
            }
        }
    }
}

int main(int argc, char *argv[]) {
    if (argc < 2) {
        fprintf(stderr, "Usage: %s <file path>\n", argv[0]);
        return 1;
    }

    FILE *file = fopen(argv[1], "r");
    if (file == NULL) {
        perror("Error opening file");
        return 1;
    }

    char *file_contents;
    long file_size;

    fseek(file, 0, SEEK_END);
    file_size = ftell(file);
    fseek(file, 0, SEEK_SET);

    file_contents = malloc(file_size + 1);
    if (file_contents == NULL) {
        perror("Error allocating memory");
        fclose(file);
        return 1;
    }

    fread(file_contents, 1, file_size, file);
    fclose(file);
    file_contents[file_size] = '\0';

    parse_json_and_find_key(file_contents);
    free(file_contents);

    printf("Final string in buffer: %s\n", global_buffer);

    return 0;
}