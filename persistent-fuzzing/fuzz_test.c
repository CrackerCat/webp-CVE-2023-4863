#include <stdio.h>
#include "src/utils/huffman_utils.c"
#include "src/utils/bit_reader_utils.c"

/* -------------------------------------------------- */
// code taken from libwebp 

#define FIXED_TABLE_SIZE (630 * 3 + 410)
static const uint16_t kTableSize[12] = {
  FIXED_TABLE_SIZE + 654,
  FIXED_TABLE_SIZE + 656,
  FIXED_TABLE_SIZE + 658,
  FIXED_TABLE_SIZE + 662,
  FIXED_TABLE_SIZE + 670,
  FIXED_TABLE_SIZE + 686,
  FIXED_TABLE_SIZE + 718,
  FIXED_TABLE_SIZE + 782,
  FIXED_TABLE_SIZE + 912,
  FIXED_TABLE_SIZE + 1168,
  FIXED_TABLE_SIZE + 1680,
  FIXED_TABLE_SIZE + 2704
};

uint32_t VP8LReadBits2(VP8LBitReader* const br, int n_bits) {
  if(n_bits >= 0);
  // Flag an error if end_of_stream or n_bits is more than allowed limit.

  if (!br->eos_ && n_bits <= VP8L_MAX_NUM_BIT_READ) {

    const uint32_t val = VP8LPrefetchBits(br) & kBitMask[n_bits];
    printf("val: %d\n", val);
    const int new_bits = br->bit_pos_ + n_bits;
    br->bit_pos_ = new_bits;
    ShiftBytes(br);
    return val;
  } else {
    VP8LSetEndOfStream(br);
    return 0;
  }
}

// vp8l_dec.c
#define NUM_CODE_LENGTH_CODES       19
static const uint8_t kCodeLengthCodeOrder[NUM_CODE_LENGTH_CODES] = {
  17, 18, 0, 1, 2, 3, 4, 5, 16, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15
};
static const int kCodeLengthLiterals = 16;
static const int kCodeLengthRepeatCode = 16;
static const uint8_t kCodeLengthExtraBits[3] = { 2, 3, 7 };
static const uint8_t kCodeLengthRepeatOffsets[3] = { 3, 3, 11 };


/* -------------------------------------------------- */


#ifndef __AFL_FUZZ_TESTCASE_LEN
  ssize_t fuzz_len;
  #define __AFL_FUZZ_TESTCASE_LEN fuzz_len
  unsigned char fuzz_buf[1024000];
  #define __AFL_FUZZ_TESTCASE_BUF fuzz_buf
  #define __AFL_FUZZ_INIT() void sync(void);
  #define __AFL_LOOP(x) ((fuzz_len = read(0, fuzz_buf, sizeof(fuzz_buf))) > 0 ? 1 : 0)
  #define __AFL_INIT() sync()
#endif

// values for the distance table with 40 symbols
#ifndef SYMS
#define SYMS 40
#endif
// we can also increase this value to find larger overflows
#ifndef TABLE_SIZE
#define TABLE_SIZE 410
#endif


__AFL_FUZZ_INIT();

int main(int argc, char **argv) {

    #ifdef __AFL_HAVE_MANUAL_CONTROL
        __AFL_INIT();
    #endif

    unsigned char *buf = __AFL_FUZZ_TESTCASE_BUF;

    while (__AFL_LOOP(10000)) {

        int length = __AFL_FUZZ_TESTCASE_LEN;

        const int code_lengths_size = SYMS;
        // buf is code_lengths[]. and we need at least SYMS entries
        if(length < code_lengths_size ) continue;

        int code_lengths[SYMS] = {0};

        // build code_lengths from AFL buf
        for (int i = 0; i < code_lengths_size; ++i) {
            code_lengths[i] = buf[i] % NUM_CODE_LENGTH_CODES;
        }

        const HuffmanCode last_table[TABLE_SIZE];
        const HuffmanCode* table = last_table;

        // 
        int ok = 1;
        int count[NUM_CODE_LENGTH_CODES + 1] = { 0 };
        for (int symbol = 0; symbol < code_lengths_size; ++symbol) {
          if (code_lengths[symbol] > NUM_CODE_LENGTH_CODES) {
            ok = 0;
            break;
          }
          ++count[code_lengths[symbol]];
        }
        if(!ok) continue;

        // print count when not instrumented with afl
        printf("[ 0");
        for (int i = 1; i <= NUM_CODE_LENGTH_CODES; ++i) {
            printf(", %d", count[i]);
        }
        printf("] = ");

        int result = VP8LBuildHuffmanTable(table, 8, code_lengths, code_lengths_size);
        printf("%d\n", result);
        
    }
}