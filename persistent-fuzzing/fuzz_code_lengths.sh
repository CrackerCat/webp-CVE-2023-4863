#!/bin/bash

mkdir /pwd/in
mkdir /pwd/_code_lengths
# clean if there was already something
rm -rf /pwd/_code_lengths/*

# prepare some random input files
dd if=/dev/random of=/pwd/in/1 bs=8 count=8
dd if=/dev/random of=/pwd/in/2 bs=8 count=32
dd if=/dev/random of=/pwd/in/3 bs=8 count=64
dd if=/dev/random of=/pwd/in/4 bs=8 count=128

cp /pwd/fuzz.c /root/libwebp/fuzz.c
cp /pwd/fuzz_test.c /root/libwebp/fuzz_test.c
# cd /root/libwebp &&                 gcc            -DTABLE_SIZE=150 -DSYM=19 -g -I. fuzz_test.c -lwebp -o /root/fuzz_test
cd /root/libwebp &&                 afl-clang-fast -DTABLE_SIZE=150 -DSYM=19 -g -I. fuzz_code_lengths.c -lwebp -o /root/fuzz_code_lengths 
cd /root/libwebp && AFL_USE_ASAN=1  afl-clang-fast -DTABLE_SIZE=150 -DSYM=19 -g -I. fuzz_code_lengths.c -lwebp -o /root/fuzz_code_lengths_asan

screen -S master -d -m afl-fuzz -i /pwd/in -o /pwd/out_code_lengths -M master /root/fuzz_code_lengths
screen -S asan -d -m afl-fuzz -i /pwd/in -o /pwd/out_code_lengths -S asan /root/fuzz_code_lengths_asan
watch -n 1 afl-whatsup /pwd/out
# screen -rd master