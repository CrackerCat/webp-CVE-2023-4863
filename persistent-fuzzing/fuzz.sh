#!/bin/bash

mkdir /pwd/in
mkdir /pwd/out
# clean if there was already something
rm -rf /pwd/out/*

# prepare some random input files
dd if=/dev/random of=/pwd/in/1 bs=8 count=8
dd if=/dev/random of=/pwd/in/2 bs=8 count=32
dd if=/dev/random of=/pwd/in/3 bs=8 count=64
dd if=/dev/random of=/pwd/in/4 bs=8 count=128

cp /pwd/fuzz.c /root/libwebp/fuzz.c
cp /pwd/fuzz_test.c /root/libwebp/fuzz_test.c
cd /root/libwebp &&                 gcc            -DTABLE_SIZE=150 -DSYM=19 -g -I. fuzz_test.c -lwebp -fsanitize=address -static-libasan -o /root/fuzz_test
cd /root/libwebp &&                 afl-clang-fast -DTABLE_SIZE=150 -DSYM=19 -g -I. fuzz.c -lwebp -o /root/fuzz 
cd /root/libwebp && AFL_USE_ASAN=1  afl-clang-fast -DTABLE_SIZE=150 -DSYM=19 -g -I. fuzz.c -lwebp -o /root/fuzz_asan

screen -S master -d -m afl-fuzz -i /pwd/in -o /pwd/out -M master /root/fuzz
screen -S asan -d -m afl-fuzz -i /pwd/in -o /pwd/out -S asan /root/fuzz_asan
watch -n 1 afl-whatsup /pwd/out
# screen -rd master