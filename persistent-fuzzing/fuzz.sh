#!/bin/bash

mkdir /pwd/in
mkdir /pwd/out
# clean if there was already something
rm -rf /pwd/out/*

# prepare some random input files
dd if=/dev/random of=/pwd/in/1 bs=8 count=8
dd if=/dev/random of=/pwd/in/2 bs=8 count=32
dd if=/dev/random of=/pwd/in/3 bs=8 count=64
dd if=/dev/random of=/pwd/in/4 bs=8 count=128

# copy the code into libwebp root to include some files
cp /pwd/fuzz.c /root/libwebp/fuzz.c
cp /pwd/fuzz_test.c /root/libwebp/fuzz_test.c

# build the fuzzing target
cd /root/libwebp &&                 gcc            -DTABLE_SIZE=500 -DSYM=40 -g -I. fuzz_test.c -lwebp -o /root/fuzz_check
cd /root/libwebp &&                 afl-clang-fast -DTABLE_SIZE=500 -DSYM=40 -g -I. fuzz_test.c -lwebp -o /root/fuzz_test 
cd /root/libwebp && AFL_USE_ASAN=1  afl-clang-fast -DTABLE_SIZE=500 -DSYM=40 -g -I. fuzz_test.c -lwebp -o /root/fuzz_test_asan

# start afl
screen -S master -d -m afl-fuzz -i /pwd/in -o /pwd/out -M master /root/fuzz_test
screen -S asan -d -m afl-fuzz -i /pwd/in -o /pwd/out -S asan /root/fuzz_test_asan
watch -n 1 afl-whatsup /pwd/out
# screen -rd master
