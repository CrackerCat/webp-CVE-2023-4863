<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script src="https://cdn.tailwindcss.com"></script>
        <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    </head>
    <body>
        <div id="app" class="bg-[#151519] text-white h-full min-h-screen py-10 px-2 ">
            <div class="flex flex-row">
                <div class=" grid place-items-center">
                    <div class="text-center text-2xl font-mono px-5">count[]=</div>
                </div>
                <div v-for="(c, i) in Array(16)" class="flex flex-col w-24 border border-gray-700 " :class="{'border-r-red-500': i==8}">
                    <button v-if="i>0" class="text-center bg-gray-700 hover:bg-gray-800 py-2" @click="() => { if(count[i]) count[i]++; render(); }">▲</button>
                    <div v-else class="text-center bg-gray-800 py-2" >&nbsp;</div>
                    <div class="text-center text-2xl font-bold font-mono py-2">{{ count[i] }}</div>
                    <button v-if="i>0" class="text-center bg-gray-700 hover:bg-gray-800 py-2" @click="() => { if(count[i]>0) count[i]--; render(); }">▼</button>
                    <div v-else class="text-center bg-gray-800 py-2" >&nbsp;</div>
                </div>
            </div>
            <div class="flex flex-row flex-wrap mt-2 ml-5">
                <div class="mt-2 mr-2 text-right">Presets:</div>
                <button class="text-center bg-gray-700 hover:bg-gray-800 py-2 px-5 mx-2"  @click="setCSVCount('0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0')">{ 0 }</button>
                <button class="text-center bg-gray-700 hover:bg-gray-800 py-2 px-5 mx-2"  @click="setCSVCount('0, 0, 0, 0, 0, 0, 3, 2, 2, 3, 12,  2,  2, 2, 0, 12')">NSO Sample</button>
                <button class="text-center bg-red-700 hover:bg-gray-800 py-2 px-5 mx-2"  @click="setCustomArray()">Set Custom</button>
            </div>
            <div class="flex flex-row mt-5">
                <div class="flex-1">
                    <div class="text-2xl font-mono px-5">HuffmanCode table[410];</div>
                    <div class="flex flex-wrap cursor-default">
                        <div 
                            v-for="(cell, i) in table" 
                            :class="{'opacity-40': i <= 410, 'text-white': cell == '00000000' && i > 410, 'bg-red-500': cell != '00000000' && i > 410}"
                            class="w-20 h-20 text-xs border border-2 align-center border-gray-800 grid place-items-center">
                            <span>
                                <span v-if="i*4 - (410*4) > 0" class="font-bold">
                                    +{{ (i*4 - (410*4)).toString(16) }} <br>
                                </span>
                                <span v-if="cell != '00000000'">
                                    {{cell}}
                                </span>
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            const { createApp, ref, onMounted } = Vue

            createApp({
                setup() {
                    const count = ref('0, 0, 0, 0, 0, 0, 3, 2, 2, 3, 12,  2,  2, 2, 0, 12'.replace(' ', '').trim().split(','))
                    const strCount = ref(count.value.join(','));
                    const img_cache = ref('')
                    const progress = ref(0);
                    const loading = ref(true);
                    const table = ref(' ');
                    const counts = [
                    '0, 0, 0, 0, 0, 0, 3, 2, 2, 3,   12,  2,  2, 2, 0, 12',
                    '0, 0, 0, 1, 0, 0, 0, 1, 1, 7, 0, 0, 0, 0, 0, 0',
                    '0, 0, 0, 1, 0, 0, 0, 1, 1, 11, 0, 0, 0, 0, 0, 0',
                    '0, 0, 0, 1, 0, 0, 0, 1, 1, 13, 0, 0, 0, 0, 0, 0',
                    '0, 0, 0, 1, 0, 0, 0, 1, 1, 17, 0, 0, 0, 0, 0, 0',
                    '0, 0, 0, 1, 0, 0, 0, 1, 1, 19, 0, 0, 0, 0, 0, 0',
                    '0, 0, 0, 1, 0, 0, 0, 1, 1, 23, 0, 0, 0, 0, 0, 0',
                    '0, 0, 0, 1, 0, 0, 0, 1, 1, 23, 3, 0, 0, 0, 0, 0',
                    '0, 0, 0, 1, 0, 0, 0, 1, 1, 23, 5, 0, 0, 0, 0, 0',
                    '0, 0, 0, 1, 0, 0, 0, 1, 1, 23, 7, 0, 0, 0, 0, 0',
                    '0, 0, 0, 1, 0, 0, 0, 1, 1, 23, 11, 0, 0, 0, 0, 0',
                    '0, 0, 0, 1, 0, 0, 0, 1, 1, 23, 13, 0, 0, 0, 0, 0',
                    '0, 0, 0, 1, 0, 0, 0, 1, 1, 23, 5, 1, 5, 0, 0, 0',
                    '0, 0, 0, 1, 0, 0, 0, 1, 1, 17, 13, 1, 5, 0, 0, 0',
                    '0, 0, 0, 1, 0, 0, 0, 1, 1, 23, 5, 1, 7, 0, 0, 0',
                    '0, 0, 0, 1, 0, 0, 0, 1, 1, 23, 5, 1, 1, 5, 0, 0',
                    '0, 0, 0, 1, 0, 0, 0, 1, 1, 23, 1, 1, 1, 7, 0, 0',
                    '0, 0, 0, 1, 0, 0, 0, 1, 1, 13, 13, 1, 1, 7, 0, 0',
                    '0, 0, 0, 1, 0, 0, 0, 1, 1, 19, 1, 1, 1, 1, 5, 0',
                    '0, 0, 0, 1, 0, 0, 0, 1, 1, 23, 1, 1, 1, 1, 5, 0',
                    '0, 0, 0, 1, 0, 0, 0, 1, 1, 23, 5, 1, 1, 1, 5, 0',
                    '0, 0, 0, 1, 0, 0, 0, 1, 1, 13, 1, 1, 1, 1, 7, 0',
                    '0, 0, 0, 1, 0, 0, 0, 1, 1, 17, 1, 1, 1, 1, 7, 0',
                    '0, 0, 0, 1, 0, 0, 0, 1, 1, 19, 1, 1, 1, 1, 7, 0',
                    '0, 0, 0, 1, 0, 0, 0, 1, 1, 23, 1, 1, 1, 1, 7, 0',
                    '0, 0, 0, 1, 0, 0, 0, 1, 1, 13, 13, 1, 1, 1, 7, 0',
                    '0, 0, 0, 1, 0, 0, 0, 1, 1, 19, 1, 1, 1, 1, 11, 0',
                    '0, 0, 0, 1, 0, 0, 0, 1, 1, 17, 5, 1, 1, 1, 11, 0',
                    ]

                    setCSVCount = (c) => {
                        count.value = c.split(',').map(c => parseInt(c));
                        render();
                    }
                    // send request on count change
                    const render = () => {

                        const args = count.value.map(c => `${c}`);
                        console.log(args)
                        Module.callMain(args);
                        var data = FS.readFile('/table', { encoding: 'binary' });
                        console.log(data);
                        var uint32Array = new Uint32Array(data.buffer);
                        console.log(uint32Array);
                        var _table = [];
                        // Loop through the Uint32Array
                        for (let i = 0; i < uint32Array.length; i++) {
                            // Convert the Uint32 element to a hexadecimal string
                            const hexString = uint32Array[i].toString(16).padStart(8, '0');
                            // Log the hexadecimal string
                            _table.push(hexString);
                        }

                        // remove all `00000000` from the end
                        while(_table[_table.length - 1] == '00000000') {
                            _table.pop();
                        }
                        console.log(_table);
                        table.value = _table;
                    }

                    onMounted(() => {
                        window.Module = {
                            onRuntimeInitialized: () => {
                                console.log('onRuntimeInitialized');
                                Module.setStatus('Running...');
                                render();
                            },
                            print: (function() {
                              var element = document.getElementById('output');
                              if (element) element.value = ''; // clear browser cache
                              return (...args) => {
                                var text = args.join(' ');
                                // These replacements are necessary if you render to raw HTML
                                //text = text.replace(/&/g, "&amp;");
                                //text = text.replace(/</g, "&lt;");
                                //text = text.replace(/>/g, "&gt;");
                                //text = text.replace('\n', '<br>', 'g');
                                console.log(text);
                                if (element) {
                                  element.value += text + "\n";
                                  element.scrollTop = element.scrollHeight; // focus on bottom
                                }
                              };
                            })(),
                            setStatus: (text) => {
                              if (!Module.setStatus.last) Module.setStatus.last = { time: Date.now(), text: '' };
                              if (text === Module.setStatus.last.text) return;
                              var m = text.match(/([^(]+)\((\d+(\.\d+)?)\/(\d+)\)/);
                              var now = Date.now();
                              if (m && now - Module.setStatus.last.time < 30) return; // if this is a progress update, skip it if too soon
                              Module.setStatus.last.time = now;
                              Module.setStatus.last.text = text;
                              console.log(text);
                              if (m) {
                                progress.value = (parseInt(m[2])*100) / (parseInt(m[4])*100);
                                loading.value = true;
                              } else {
                                if(!text) { 
                                    loading.value = false;
                                }
                              }
                            },
                            totalDependencies: 0,
                            monitorRunDependencies: (left) => {
                              this.totalDependencies = Math.max(this.totalDependencies, left);
                              Module.setStatus(left ? 'Preparing... (' + (this.totalDependencies-left) + '/' + this.totalDependencies + ')' : 'All downloads complete.');
                            }
                          };

                          Module.setStatus('Downloading...');
                          
                          window.onerror = (event) => {
                            // TODO: do not warn on ok events like simulating an infinite loop or exitStatus
                            Module.setStatus('Exception thrown, see JavaScript console');
                            loading.value = false;
                            Module.setStatus = (text) => {
                              if (text) console.error('[post-exception status] ' + text);
                            };
                          };

                          var script = document.createElement('script');
                            script.src = 'dump_table-1.js'; // Ensure this is the correct path
                            document.head.appendChild(script);

                        
                    })

                    const setCustomArray = () => {
                        const c = prompt('Enter custom array');
                        if(c) {
                            setCSVCount(c);
                            render();
                        }
                    }
                    return {
                        count, table, render, img_cache, counts, progress, loading, setCSVCount, setCustomArray
                    }
                }
            }).mount('#app')
        </script>

  </body>
</html>
