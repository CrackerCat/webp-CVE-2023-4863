#export AFL_LLVM_ALLOWLIST=/root/func.list
#export AFL_FAST_CAL=1 AFL_IMPORT_FIRST=1 AFL_DISABLE_TRIM=1 AFL_AUTORESUME=1

# sources already added in Dockerfile
#cd /root/ && git clone https://chromium.googlesource.com/webm/libwebp && git checkout v1.3.1 
cd /root/libwebp/ && git apply /root/afl_instrumentation.diff
cd /root/libwebp/ && ./autogen.sh && CC=afl-clang-fast ./configure

# build different instrumented versions
                   make clean all && cp -r /root/libwebp /root/dwebp_afl
AFL_USE_ASAN=1     make clean all && cp -r /root/libwebp /root/dwebp_afl_asan
AFL_LLVM_LAF_ALL=1 make clean all && cp -r /root/libwebp /root/dwebp_afl_compcov
AFL_LLVM_CMPLOG=1  make clean all && cp -r /root/libwebp /root/dwebp_afl_cmplog
#AFL_LLVM_INSTRUMENT=CTX     make clean all && cp -r /root/libwebp /root/dwebp_afl_ctx
#AFL_LLVM_INSTRUMENT=NGRAM-8 make clean all && cp -r /root/libwebp /root/dwebp_afl_ngram

mkdir /tmp/in/
mkdir /pwd/out/
rm -rf /pwd/out/*

# get the input files for the fuzzer
wget https://www.gstatic.com/webp/gallery/1.webp -O /tmp/in/1.webp
wget https://www.gstatic.com/webp/gallery/2.webp -O /tmp/in/2.webp
wget https://www.gstatic.com/webp/gallery/3.webp -O /tmp/in/3.webp
wget https://www.gstatic.com/webp/gallery/4.webp -O /tmp/in/4.webp
wget https://www.gstatic.com/webp/gallery/5.webp -O /tmp/in/5.webp
wget https://raw.githubusercontent.com/signalapp/Signal-Android/main/glide-webp/app/src/main/assets/test_01.webp -O /tmp/in/test_01.webp
wget https://raw.githubusercontent.com/signalapp/Signal-Android/main/glide-webp/app/src/main/assets/test_02.webp -O /tmp/in/test_02.webp
wget https://raw.githubusercontent.com/signalapp/Signal-Android/main/glide-webp/app/src/main/assets/test_03.webp -O /tmp/in/test_03.webp
wget https://raw.githubusercontent.com/signalapp/Signal-Android/main/glide-webp/app/src/main/assets/test_04.webp -O /tmp/in/test_04.webp
wget https://raw.githubusercontent.com/signalapp/Signal-Android/main/glide-webp/app/src/main/assets/test_05.webp -O /tmp/in/test_05.webp
wget https://raw.githubusercontent.com/signalapp/Signal-Android/main/glide-webp/app/src/main/assets/test_06_lossless.webp -O /tmp/in/test_06_lossless.webp
wget https://raw.githubusercontent.com/signalapp/Signal-Android/main/glide-webp/app/src/main/assets/test_06_lossy.webp -O /tmp/in/test_06_lossy.webp
wget https://raw.githubusercontent.com/signalapp/Signal-Android/main/glide-webp/app/src/main/assets/test_07_lossless.webp -O /tmp/in/test_07_lossless.webp
wget https://raw.githubusercontent.com/signalapp/Signal-Android/main/glide-webp/app/src/main/assets/test_07_lossy.webp -O /tmp/in/test_07_lossy.webp
wget https://raw.githubusercontent.com/signalapp/Signal-Android/main/glide-webp/app/src/main/assets/test_08_lossless.webp -O /tmp/in/test_08_lossless.webp
wget https://raw.githubusercontent.com/signalapp/Signal-Android/main/glide-webp/app/src/main/assets/test_08_lossy.webp -O /tmp/in/test_08_lossy.webp
wget https://raw.githubusercontent.com/signalapp/Signal-Android/main/glide-webp/app/src/main/assets/test_09_large.webp -O /tmp/in/test_09_large.webp

# start the fuzzers in a screen
# webp binary expects the webp library, so we also have to set the LD_LIBRARY_PATH for the target binary
AFL_TARGET_ENV='LD_LIBRARY_PATH="/root/dwebp_afl/src/demux/.libs:/root/dwebp_afl/src/.libs:/root/dwebp_afl/sharpyuv/.libs:$LD_LIBRARY_PATH"'                           screen -S master -d -m afl-fuzz -i /tmp/in -o /pwd/out -M master /root/dwebp_afl/examples/.libs/dwebp -v @@
AFL_TARGET_ENV='LD_LIBRARY_PATH="/root/dwebp_afl_asan/src/demux/.libs:/root/dwebp_afl_asan/src/.libs:/root/dwebp_afl_asan/sharpyuv/.libs:$LD_LIBRARY_PATH"'            screen -S asan1 -d -m afl-fuzz -i /tmp/in -o /pwd/out -S asan1 /root/dwebp_afl_asan/examples/.libs/dwebp -v @@ 
AFL_TARGET_ENV='LD_LIBRARY_PATH="/root/dwebp_afl_ngram/src/demux/.libs:/root/dwebp_afl_ngram/src/.libs:/root/dwebp_afl_ngram/sharpyuv/.libs:$LD_LIBRARY_PATH"'         screen -S asan2 -d -m afl-fuzz -i /tmp/in -o /pwd/out -S asan2 /root/dwebp_afl_ngram/examples/.libs/dwebp -v @@ 
AFL_TARGET_ENV='LD_LIBRARY_PATH="/root/dwebp_afl_compcov/src/demux/.libs:/root/dwebp_afl_compcov/src/.libs:/root/dwebp_afl_compcov/sharpyuv/.libs:$LD_LIBRARY_PATH"'   screen -S compcov -d -m afl-fuzz -i /tmp/in -o /pwd/out -S compcov /root/dwebp_afl_compcov/examples/.libs/dwebp -v @@ 
AFL_TARGET_ENV='LD_LIBRARY_PATH="/root/dwebp_afl_cmplog/src/demux/.libs:/root/dwebp_afl_cmplog/src/.libs:/root/dwebp_afl_cmplog/sharpyuv/.libs:$LD_LIBRARY_PATH"'      screen -S cmplog -d -m afl-fuzz -i /tmp/in -o /pwd/out -S cmplog -c /root/dwebp_afl_cmplog/examples/.libs/dwebp -m none -- /root/dwebp_afl/examples/.libs/dwebp -v @@ 
AFL_TARGET_ENV='LD_LIBRARY_PATH="/root/dwebp_afl_ctx/src/demux/.libs:/root/dwebp_afl_ctx/src/.libs:/root/dwebp_afl_ctx/sharpyuv/.libs:$LD_LIBRARY_PATH"'               screen -S ctx -d -m afl-fuzz -i /tmp/in -o /pwd/out -S ctx /root/dwebp_afl_ctx/examples/.libs/dwebp -v @@ 

apt-get install -yq lcov python2
cd /root/ && git clone https://github.com/mrash/afl-cov

# prepare coverage and genhtml
make clean all && cp -r /root/libwebp /root/libwebp_cov
cd /root/libwebp_cov && CFLAGS="-fprofile-arcs -ftest-coverage" ./configure && make clean all

python2 /root/afl-cov/afl-cov -d /pwd/genhtml/ --live --coverage-cmd "LD_LIBRARY_PATH=\"/root/libwebp_cov/src/demux/.libs:/root/libwebp_cov/src/.libs:/root/libwebp_cov/sharpyuv/.libs:\" /root/libwebp_cov/examples/.libs/dwebp -v AFL_FILE" --code-dir .

watch -n 1 afl-whatsup /pwd/out